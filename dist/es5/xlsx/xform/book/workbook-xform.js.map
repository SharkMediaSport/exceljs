{"version":3,"sources":["../../../../../lib/xlsx/xform/book/workbook-xform.js"],"names":["_","require","utils","colCache","XmlStream","BaseXform","StaticXform","ListXform","DefinedNameXform","SheetXform","WorkbookViewXform","WorkbookPropertiesXform","WorkbookXform","module","exports","map","fileVersion","STATIC_XFORMS","workbookPr","bookViews","tag","count","childXform","sheets","definedNames","calcPr","inherits","WORKBOOK_ATTRIBUTES","xmlns","$","appName","lastEdited","lowestEdited","rupBuild","calcId","prepare","model","worksheets","printAreas","index","forEach","sheet","pageSetup","printArea","definedName","name","ranges","localSheetId","push","printTitlesRow","printTitlesColumn","titlesColumns","split","titlesRows","length","concat","media","medium","i","type","render","xmlStream","openXml","StdDocAttributes","openNode","properties","views","closeNode","parseOpen","node","parser","parseText","text","parseClose","undefined","reconcile","rels","workbookRels","reduce","rel","Id","worksheet","rId","worksheetHash","Target","id","state","each","range","decodeEx","dimensions","rangeString","join","rowRangeRegex","rowRangeMatches","match","columnRangeRegex","columnRangeMatches"],"mappings":"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","file":"workbook-xform.js","sourcesContent":["'use strict';\n\nvar _ = require('../../../utils/under-dash');\n\nvar utils = require('../../../utils/utils');\nvar colCache = require('../../../utils/col-cache');\nvar XmlStream = require('../../../utils/xml-stream');\n\nvar BaseXform = require('../base-xform');\nvar StaticXform = require('../static-xform');\nvar ListXform = require('../list-xform');\nvar DefinedNameXform = require('./defined-name-xform');\nvar SheetXform = require('./sheet-xform');\nvar WorkbookViewXform = require('./workbook-view-xform');\nvar WorkbookPropertiesXform = require('./workbook-properties-xform');\n\nvar WorkbookXform = module.exports = function() {\n  this.map = {\n    fileVersion: WorkbookXform.STATIC_XFORMS.fileVersion,\n    workbookPr: new WorkbookPropertiesXform(),\n    bookViews: new ListXform({tag: 'bookViews', count: false, childXform: new WorkbookViewXform()}),\n    sheets: new ListXform({tag: 'sheets', count: false, childXform: new SheetXform()}),\n    definedNames: new ListXform({tag: 'definedNames', count: false, childXform: new DefinedNameXform()}),\n    calcPr: WorkbookXform.STATIC_XFORMS.calcPr\n  };\n};\n\nutils.inherits(WorkbookXform, BaseXform, {\n  WORKBOOK_ATTRIBUTES: {\n    xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n    'xmlns:r': 'http://schemas.openxmlformats.org/officeDocument/2006/relationships',\n    'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\n    'mc:Ignorable': 'x15',\n    'xmlns:x15': 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main'\n  },\n  STATIC_XFORMS: {\n    fileVersion: new StaticXform({tag: 'fileVersion', $: {appName: 'xl', lastEdited: 5, lowestEdited: 5, rupBuild: 9303}}),\n    calcPr: new StaticXform({tag: 'calcPr', $: {calcId: 171027}})\n  }\n}, {\n\n  prepare: function(model) {\n    model.sheets = model.worksheets;\n\n    // collate all the print areas from all of the sheets and add them to the defined names\n    var printAreas = [];\n    var index = 0; // sheets is sparse array - calc index manually\n    model.sheets.forEach(function(sheet) {\n      if (sheet.pageSetup && sheet.pageSetup.printArea) {\n        const definedName = {\n          name: '_xlnm.Print_Area',\n          ranges: [sheet.name + '!' + sheet.pageSetup.printArea],\n          localSheetId: index\n        };\n        printAreas.push(definedName);\n      }\n      if (sheet.pageSetup && (sheet.pageSetup.printTitlesRow || sheet.pageSetup.printTitlesColumn)) {\n\n        let ranges = [];\n\n        if (sheet.pageSetup.printTitlesColumn) {\n\n          const titlesColumns = sheet.pageSetup.printTitlesColumn.split(':');\n          ranges.push('\\'' + sheet.name + '\\'!$' + titlesColumns[0] + ':$' + titlesColumns[1]);\n        }\n\n        if (sheet.pageSetup.printTitlesRow) {\n\n          const titlesRows = sheet.pageSetup.printTitlesRow.split(':');\n          ranges.push('\\'' + sheet.name + '\\'!$' + titlesRows[0] + ':$' + titlesRows[1]);\n        }\n\n        const definedName = {\n            name: '_xlnm.Print_Titles',\n            ranges: ranges,\n            localSheetId: index\n        };\n\n        printAreas.push(definedName);\n      }\n      index++;\n    });\n    if (printAreas.length) {\n      model.definedNames = model.definedNames.concat(printAreas);\n    }\n\n    model.media && model.media.forEach(function(medium, i) {\n      // assign name\n      medium.name = medium.type + (i + 1);\n    });\n  },\n\n  render: function(xmlStream, model) {\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n    xmlStream.openNode('workbook', WorkbookXform.WORKBOOK_ATTRIBUTES);\n\n    this.map.fileVersion.render(xmlStream);\n    this.map.workbookPr.render(xmlStream, model.properties);\n    this.map.bookViews.render(xmlStream, model.views);\n    this.map.sheets.render(xmlStream, model.sheets);\n    this.map.definedNames.render(xmlStream, model.definedNames);\n    this.map.calcPr.render(xmlStream);\n\n    xmlStream.closeNode();\n  },\n\n  parseOpen: function(node) {\n    if (this.parser) {\n      this.parser.parseOpen(node);\n      return true;\n    }\n    switch (node.name) {\n      case 'workbook':\n        return true;\n      default:\n        this.parser = this.map[node.name];\n        if (this.parser) {\n          this.parser.parseOpen(node);\n        }\n        return true;\n    }\n  },\n  parseText: function(text) {\n    if (this.parser) {\n      this.parser.parseText(text);\n    }\n  },\n  parseClose: function(name) {\n    if (this.parser) {\n      if (!this.parser.parseClose(name)) {\n        this.parser = undefined;\n      }\n      return true;\n    }\n    switch (name) {\n      case 'workbook':\n        this.model = {\n          sheets: this.map.sheets.model,\n          properties: this.map.workbookPr.model || {},\n          views: this.map.bookViews.model\n        };\n        if (this.map.definedNames.model) {\n          this.model.definedNames = this.map.definedNames.model;\n        }\n\n        return false;\n      default:\n        // not quite sure how we get here!\n        return true;\n    }\n  },\n\n  reconcile: function(model) {\n    var rels = (model.workbookRels || []).reduce(function(map, rel) {\n      map[rel.Id] = rel;\n      return map;\n    }, {});\n\n    // reconcile sheet ids, rIds and names\n    var worksheets = [];\n    var worksheet;\n    var index = 0;\n\n    (model.sheets || []).forEach(function(sheet) {\n      var rel = rels[sheet.rId];\n      if (!rel) {\n        return;\n      }\n      worksheet = model.worksheetHash['xl/' + rel.Target];\n      // If there are \"chartsheets\" in the file, rel.Target will\n      // come out as chartsheets/sheet1.xml or similar here, and\n      // that won't be in model.worksheetHash.\n      // As we don't have the infrastructure to support chartsheets,\n      // we will ignore them for now:\n      if (worksheet) {\n        worksheet.name = sheet.name;\n        worksheet.id = sheet.id;\n        worksheet.state = sheet.state;\n        worksheets[index++] = worksheet;\n      }\n    });\n\n    // reconcile print areas\n    var definedNames = [];\n    _.each(model.definedNames, function(definedName) {\n      if (definedName.name === '_xlnm.Print_Area') {\n        worksheet = worksheets[definedName.localSheetId];\n        if (worksheet) {\n          if (!worksheet.pageSetup) {\n            worksheet.pageSetup = {};\n          }\n          const range = colCache.decodeEx(definedName.ranges[0]);\n          worksheet.pageSetup.printArea = range.dimensions;\n        }\n      } else if (definedName.name === '_xlnm.Print_Titles') {\n        worksheet = worksheets[definedName.localSheetId];\n        if (worksheet) {\n          if (!worksheet.pageSetup) {\n            worksheet.pageSetup = {};\n          }\n\n          const rangeString = definedName.ranges.join(\",\");\n\n          const rowRangeRegex = /\\$\\d+:\\$\\d+/;\n          const rowRangeMatches = rangeString.match(rowRangeRegex);\n\n          if (rowRangeMatches && rowRangeMatches.length) {\n\n            worksheet.pageSetup.printTitlesRow = rowRangeMatches[0];\n          }\n\n          const columnRangeRegex = /\\$[A-Z]+:\\$[A-Z]+/;\n          const columnRangeMatches = rangeString.match(columnRangeRegex);\n\n          if (columnRangeMatches && columnRangeMatches.length) {\n\n            worksheet.pageSetup.printTitlesColumn = columnRangeMatches[0];\n          }\n\n        }\n      } else {\n        definedNames.push(definedName);\n      }\n    });\n    model.definedNames = definedNames;\n\n    // used by sheets to build their image models\n    model.media.forEach((media, i) => {\n      media.index = i;\n    });\n  }\n});\n"]}